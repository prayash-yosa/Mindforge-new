<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Task 2.3 Business Layer Skeleton</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;line-height:1.6;color:#1a1a1a}
table{border-collapse:collapse;width:100%;margin:1rem 0}
th,td{border:1px solid #d0d0d0;padding:0.5rem 0.75rem;text-align:left}
th{background:#f5f5f5;font-weight:600}
code{background:#f0f0f0;padding:0.15rem 0.3rem;border-radius:3px;font-size:0.9em}
pre{background:#f5f5f5;padding:1rem;border-radius:6px;overflow-x:auto}
pre code{background:none;padding:0}
h1{border-bottom:2px solid #333;padding-bottom:0.5rem}
h2{color:#333;margin-top:2rem}
h3{color:#555}
</style>
</head>
<body><h1>Task 2.3 — Business Layer Skeleton and Dependency Injection</h1>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sprint</strong></td>
<td>2 — Data &amp; Backend Core</td>
</tr>
<tr>
<td><strong>Task</strong></td>
<td>2.3</td>
</tr>
<tr>
<td><strong>Title</strong></td>
<td>Business layer skeleton and dependency injection</td>
</tr>
<tr>
<td><strong>Type</strong></td>
<td>Hardening</td>
</tr>
<tr>
<td><strong>Stack</strong></td>
<td>NestJS Services + Domain Exceptions</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>Done</td>
</tr>
<tr>
<td><strong>Started</strong></td>
<td>2026-02-12</td>
</tr>
<tr>
<td><strong>Completed</strong></td>
<td>2026-02-12</td>
</tr>
<tr>
<td><strong>Dependencies</strong></td>
<td>Task 2.2</td>
</tr>
</tbody>
</table>
<hr />
<h2>Checklist</h2>
<ul>
<li>[x] Business services for: auth (MPIN verify, lockout), today's plan, activities, grading, attendance, doubts (stubs OK where not yet implemented)</li>
<li>[x] API layer calls business layer only; business layer calls data access and external (AI, NotebookLM) only</li>
<li>[x] Domain exceptions (e.g. InvalidMPIN, LockedOut, ActivityNotFound) mapped to API codes/messages; no stack to client</li>
</ul>
<hr />
<h2>Implementation Details</h2>
<h3>Business Services</h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Module</th>
<th>Key Methods</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthService</code></td>
<td>auth</td>
<td>verifyMpin, getLockoutStatus, initForgotMpin</td>
<td>Full (Sprint 1)</td>
</tr>
<tr>
<td><code>StudentService</code></td>
<td>student</td>
<td>getTodayPlan, getProfile, getSyncStatus</td>
<td>Full (today's plan) + stubs</td>
</tr>
<tr>
<td><code>ActivitiesService</code></td>
<td>activities</td>
<td>getActivity, submitAnswer, pauseActivity, getResult</td>
<td>Full logic</td>
</tr>
<tr>
<td><code>GradingService</code></td>
<td>activities</td>
<td>grade (deterministic for MCQ/TF/fill; AI stub)</td>
<td>Partial — AI deferred</td>
</tr>
<tr>
<td><code>AttendanceService</code></td>
<td>attendance</td>
<td>getAttendance (summary + calendar)</td>
<td>Full</td>
</tr>
<tr>
<td><code>DoubtService</code></td>
<td>activities</td>
<td>getThreads, getThread, createMessage (AI stub)</td>
<td>Full structure, AI stub</td>
</tr>
</tbody>
</table>
<h3>Domain Exceptions</h3>
<table>
<thead>
<tr>
<th>Exception</th>
<th>HTTP Status</th>
<th>Code</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>InvalidMpinException</code></td>
<td>401</td>
<td><code>INVALID_CREDENTIALS</code></td>
<td>Wrong MPIN</td>
</tr>
<tr>
<td><code>AccountLockedException</code></td>
<td>403</td>
<td><code>ACCOUNT_LOCKED</code></td>
<td>Too many failed attempts</td>
</tr>
<tr>
<td><code>TokenExpiredException</code></td>
<td>401</td>
<td><code>TOKEN_EXPIRED</code></td>
<td>JWT expired</td>
</tr>
<tr>
<td><code>ActivityNotFoundException</code></td>
<td>404</td>
<td><code>ACTIVITY_NOT_FOUND</code></td>
<td>Activity doesn't exist or not accessible</td>
</tr>
<tr>
<td><code>ActivityAlreadyCompletedException</code></td>
<td>409</td>
<td><code>ACTIVITY_ALREADY_COMPLETED</code></td>
<td>Trying to submit to completed activity</td>
</tr>
<tr>
<td><code>ActivityExpiredException</code></td>
<td>410</td>
<td><code>ACTIVITY_EXPIRED</code></td>
<td>Past due date</td>
</tr>
<tr>
<td><code>QuestionNotFoundException</code></td>
<td>404</td>
<td><code>QUESTION_NOT_FOUND</code></td>
<td>Question doesn't exist</td>
</tr>
<tr>
<td><code>DoubtThreadNotFoundException</code></td>
<td>404</td>
<td><code>DOUBT_THREAD_NOT_FOUND</code></td>
<td>Thread doesn't exist or not accessible</td>
</tr>
<tr>
<td><code>StudentNotFoundException</code></td>
<td>404</td>
<td><code>STUDENT_NOT_FOUND</code></td>
<td>Student doesn't exist</td>
</tr>
<tr>
<td><code>AiUnavailableException</code></td>
<td>503</td>
<td><code>AI_UNAVAILABLE</code></td>
<td>AI provider timeout/failure</td>
</tr>
</tbody>
</table>
<p>All domain exceptions are caught by <code>GlobalExceptionFilter</code> and returned as <code>{ code, message, details? }</code>.</p>
<h3>Layering Enforcement</h3>
<pre><code>Controller (HTTP only)
    → Service (business logic only)
        → Repository (DB only)
        → External service (AI, NotebookLM) — stubs
</code></pre>
<ul>
<li>Controllers have NO business logic</li>
<li>Services have NO HTTP concerns and NO direct DB access</li>
<li>Repositories have NO business logic</li>
<li>Cross-module DB access is forbidden (each module uses its own repos or global DatabaseModule)</li>
</ul>
<h3>Module Wiring</h3>
<table>
<thead>
<tr>
<th>Module</th>
<th>Controller</th>
<th>Service</th>
<th>Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthModule</code></td>
<td>AuthController</td>
<td>AuthService, AuthPolicy</td>
<td>AuthRepository, JwtModule</td>
</tr>
<tr>
<td><code>StudentModule</code></td>
<td>StudentController</td>
<td>StudentService</td>
<td>StudentRepository, ActivityRepository, ResponseRepository</td>
</tr>
<tr>
<td><code>ActivitiesModule</code></td>
<td>(Sprint 3)</td>
<td>ActivitiesService, GradingService, DoubtService</td>
<td>ActivityRepo, QuestionRepo, ResponseRepo, DoubtRepo, StudentRepo</td>
</tr>
<tr>
<td><code>AttendanceModule</code></td>
<td>(Sprint 5)</td>
<td>AttendanceService</td>
<td>AttendanceRepository, StudentRepository</td>
</tr>
</tbody>
</table>
<hr />
<h2>Files Created</h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/common/exceptions/domain.exceptions.ts</code></td>
<td>All domain exception classes</td>
</tr>
<tr>
<td><code>src/modules/student/student.service.ts</code></td>
<td>Today's plan, profile, sync status</td>
</tr>
<tr>
<td><code>src/modules/activities/activities.service.ts</code></td>
<td>Activity lifecycle (get, submit, pause, results)</td>
</tr>
<tr>
<td><code>src/modules/activities/grading.service.ts</code></td>
<td>Deterministic + AI grading rules</td>
</tr>
<tr>
<td><code>src/modules/activities/doubt.service.ts</code></td>
<td>Doubt threads with AI stub</td>
</tr>
<tr>
<td><code>src/modules/attendance/attendance.service.ts</code></td>
<td>Attendance summary + calendar</td>
</tr>
<tr>
<td><code>src/modules/student/student.module.ts</code></td>
<td><strong>Modified</strong> — wired StudentService</td>
</tr>
<tr>
<td><code>src/modules/activities/activities.module.ts</code></td>
<td><strong>Modified</strong> — wired all services</td>
</tr>
<tr>
<td><code>src/modules/attendance/attendance.module.ts</code></td>
<td><strong>Modified</strong> — wired AttendanceService</td>
</tr>
</tbody>
</table>
<hr />
<h2>Verification</h2>
<table>
<thead>
<tr>
<th>Test</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>Server starts with all modules initialized</td>
<td>Pass</td>
</tr>
<tr>
<td>Auth flow (login, JWT, protected route) works end-to-end with TypeORM</td>
<td>Pass</td>
</tr>
<tr>
<td>Health check returns 200</td>
<td>Pass</td>
</tr>
<tr>
<td>Invalid token returns 401 with domain error code</td>
<td>Pass</td>
</tr>
<tr>
<td>OpenAPI docs accessible at /api/docs</td>
<td>Pass</td>
</tr>
<tr>
<td>TypeScript build clean (zero errors)</td>
<td>Pass</td>
</tr>
</tbody>
</table></body>
</html>