<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task 1.1 — API Gateway and Request Validation | Mindforge</title>
  <style>
    :root { --sage: #748b75; --brown: #503d42; --cream: #f5fbef; --white: #fff; --border: #d4d8d4; --green: #5cb85c; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--cream); color: var(--brown); line-height: 1.6; padding: 2rem; max-width: 1000px; margin: 0 auto; }
    h1 { color: var(--sage); margin-bottom: .5rem; font-size: 1.8rem; }
    h2 { color: var(--sage); margin: 2rem 0 .75rem; border-bottom: 2px solid var(--sage); padding-bottom: .4rem; }
    h3 { color: var(--brown); margin: 1.5rem 0 .5rem; }
    .meta { color: #777; font-size: .9rem; margin-bottom: 1.5rem; }
    .meta span { display: inline-block; margin-right: 1.5rem; }
    .badge { display: inline-block; padding: .2rem .7rem; border-radius: 4px; font-size: .85rem; font-weight: 600; }
    .badge-done { background: var(--green); color: var(--white); }
    .badge-v2 { background: var(--sage); color: var(--white); }
    .badge-nest { background: #e0234e; color: var(--white); }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { padding: .6rem .8rem; text-align: left; border: 1px solid var(--border); font-size: .9rem; }
    th { background: var(--sage); color: var(--white); }
    tr:nth-child(even) { background: #eef5e8; }
    code, pre { font-family: 'Fira Code', Consolas, monospace; background: #e8ece6; border-radius: 3px; }
    code { padding: .15rem .4rem; font-size: .85rem; }
    pre { padding: 1rem; overflow-x: auto; margin: 1rem 0; font-size: .82rem; line-height: 1.6; }
    pre code { background: none; padding: 0; }
    .file-tree { background: #e8ece6; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: .82rem; line-height: 1.7; }
    hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
  </style>
</head>
<body>

  <h1>Task 1.1 — API Gateway and Request Validation</h1>
  <div class="meta">
    <span><strong>Sprint:</strong> 1 — Foundation &amp; Auth</span>
    <span><strong>Stack:</strong> <span class="badge badge-nest">NestJS + TypeScript</span></span>
    <span><strong>Mode:</strong> <span class="badge badge-v2">V2 Enterprise</span></span>
    <span><strong>Status:</strong> <span class="badge badge-done">Done</span></span>
    <span><strong>Date:</strong> 2026-02-10</span>
    <span><strong>SP:</strong> 2</span>
  </div>

  <h2>Stack (Locked)</h2>
  <table>
    <tr><th>Area</th><th>Choice</th></tr>
    <tr><td>Framework</td><td>NestJS 10 (TypeScript) — architecture enforced like Spring Boot</td></tr>
    <tr><td>Validation</td><td>class-validator + class-transformer (DTO validation everywhere)</td></tr>
    <tr><td>API Docs</td><td>@nestjs/swagger (OpenAPI = source of truth)</td></tr>
    <tr><td>Rate Limiting</td><td>@nestjs/throttler (global, X-RateLimit headers)</td></tr>
    <tr><td>Security</td><td>Helmet 8 (CSP, HSTS, X-Frame-Options, etc.)</td></tr>
    <tr><td>Data</td><td>PostgreSQL + Redis (Task 2.1 / 8.3)</td></tr>
  </table>

  <h2>Acceptance Criteria</h2>
  <table>
    <tr><th>#</th><th>Criterion</th><th>Status</th></tr>
    <tr><td>1</td><td>REST API layer accepts HTTPS only; JSON request/response</td><td><span class="badge badge-done">Done</span></td></tr>
    <tr><td>2</td><td>Request body and query validation; invalid input → 400 + consistent error shape</td><td><span class="badge badge-done">Done</span></td></tr>
    <tr><td>3</td><td>Error response shape <code>{ code, message, details? }</code> for 400–500</td><td><span class="badge badge-done">Done</span></td></tr>
    <tr><td>4</td><td>Health check endpoint for load balancer</td><td><span class="badge badge-done">Done</span></td></tr>
    <tr><td>5</td><td>No business or DB logic in API layer; delegates to business layer</td><td><span class="badge badge-done">Done</span></td></tr>
  </table>

  <h2>Security Baseline (Day 1)</h2>
  <table>
    <tr><th>Feature</th><th>Implementation</th></tr>
    <tr><td>Central Auth module</td><td>AuthGuard (global, @Public bypass)</td></tr>
    <tr><td>Central Authorization Guards</td><td>AuthorizationGuard + @Roles() decorator</td></tr>
    <tr><td>Global rate limiting</td><td>ThrottlerGuard (X-RateLimit headers)</td></tr>
    <tr><td>Audit log service</td><td>AuditService (global, structured, no PII)</td></tr>
    <tr><td>Secrets from vault</td><td>.env template; vault in Task 8.2</td></tr>
    <tr><td>MPIN + lockout at gateway</td><td>AuthPolicy (5 attempts → lockout 15 min)</td></tr>
  </table>

  <h2>Code Structure</h2>
  <div class="file-tree">
    backend/src/<br>
    ├── main.ts<br>
    ├── app.module.ts<br>
    ├── config/<br>
    │&nbsp;&nbsp;&nbsp;├── config.module.ts<br>
    │&nbsp;&nbsp;&nbsp;└── configuration.ts<br>
    ├── common/<br>
    │&nbsp;&nbsp;&nbsp;├── decorators/ &nbsp;&nbsp;&nbsp;<em>@Public(), @Roles()</em><br>
    │&nbsp;&nbsp;&nbsp;├── dto/ &nbsp;&nbsp;&nbsp;<em>ErrorResponseDto</em><br>
    │&nbsp;&nbsp;&nbsp;├── filters/ &nbsp;&nbsp;&nbsp;<em>GlobalExceptionFilter</em><br>
    │&nbsp;&nbsp;&nbsp;├── guards/ &nbsp;&nbsp;&nbsp;<em>AuthGuard, AuthorizationGuard</em><br>
    │&nbsp;&nbsp;&nbsp;├── interceptors/ &nbsp;&nbsp;&nbsp;<em>RequestId, Logging</em><br>
    │&nbsp;&nbsp;&nbsp;└── middleware/ &nbsp;&nbsp;&nbsp;<em>HTTPS, JSON-only</em><br>
    ├── modules/<br>
    │&nbsp;&nbsp;&nbsp;├── <strong>auth/</strong> &nbsp;&nbsp;&nbsp;<em>controller → service → repository + policy + DTOs</em><br>
    │&nbsp;&nbsp;&nbsp;├── <strong>health/</strong><br>
    │&nbsp;&nbsp;&nbsp;├── student/ &nbsp;&nbsp;&nbsp;<em>(stub)</em><br>
    │&nbsp;&nbsp;&nbsp;├── attendance/ &nbsp;&nbsp;&nbsp;<em>(stub)</em><br>
    │&nbsp;&nbsp;&nbsp;└── activities/ &nbsp;&nbsp;&nbsp;<em>(stub)</em><br>
    └── shared/<br>
    &nbsp;&nbsp;&nbsp;&nbsp;├── audit/ &nbsp;&nbsp;&nbsp;<em>AuditService (global)</em><br>
    &nbsp;&nbsp;&nbsp;&nbsp;└── database/ &nbsp;&nbsp;&nbsp;<em>(Task 2.1)</em>
  </div>

  <h2>Error Response Shape</h2>
  <pre><code>{
  "code": "VALIDATION_ERROR",
  "message": "Request validation failed",
  "details": [
    { "message": "MPIN must be exactly 6 digits" },
    { "message": "property hacked should not exist" }
  ]
}</code></pre>

  <h2>Verification Results</h2>
  <table>
    <tr><th>Test</th><th>Expected</th><th>Result</th></tr>
    <tr><td><code>GET /health</code></td><td>200 + JSON status</td><td>Pass</td></tr>
    <tr><td><code>GET /nonexistent</code></td><td>404 + error shape</td><td>Pass</td></tr>
    <tr><td>MPIN too short</td><td>400 + validation details</td><td>Pass</td></tr>
    <tr><td>Missing MPIN</td><td>400 + validation details</td><td>Pass</td></tr>
    <tr><td>Unknown property</td><td>400 + forbidNonWhitelisted</td><td>Pass</td></tr>
    <tr><td>Valid MPIN</td><td>500 + business stub</td><td>Pass</td></tr>
    <tr><td>Invalid JSON</td><td>400 + BAD_REQUEST</td><td>Pass</td></tr>
    <tr><td>Wrong Content-Type</td><td>415</td><td>Pass</td></tr>
    <tr><td>Security headers</td><td>Helmet + X-Request-Id</td><td>Pass</td></tr>
    <tr><td>Rate limit headers</td><td>X-RateLimit-*</td><td>Pass</td></tr>
    <tr><td>Swagger UI</td><td>200 at /api/docs</td><td>Pass</td></tr>
    <tr><td>TypeScript build</td><td>Zero errors</td><td>Pass</td></tr>
  </table>

  <hr />
  <p style="font-size:.85rem; color:#999;">
    Dev Agent — Mindforge Student Experience | Task 1.1 rebuilt on NestJS+TypeScript | 2026-02-10
  </p>

</body>
</html>
