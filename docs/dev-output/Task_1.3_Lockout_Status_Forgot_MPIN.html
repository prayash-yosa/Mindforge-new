<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Task 1.3 Lockout Status Forgot MPIN</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;line-height:1.6;color:#1a1a1a}
table{border-collapse:collapse;width:100%;margin:1rem 0}
th,td{border:1px solid #d0d0d0;padding:0.5rem 0.75rem;text-align:left}
th{background:#f5f5f5;font-weight:600}
code{background:#f0f0f0;padding:0.15rem 0.3rem;border-radius:3px;font-size:0.9em}
pre{background:#f5f5f5;padding:1rem;border-radius:6px;overflow-x:auto}
pre code{background:none;padding:0}
h1{border-bottom:2px solid #333;padding-bottom:0.5rem}
h2{color:#333;margin-top:2rem}
h3{color:#555}
</style>
</head>
<body><h1>Task 1.3 — Lockout Status and Forgot MPIN Entry Points</h1>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sprint</strong></td>
<td>1 — Foundation &amp; Auth</td>
</tr>
<tr>
<td><strong>Task</strong></td>
<td>1.3</td>
</tr>
<tr>
<td><strong>Title</strong></td>
<td>Lockout status and Forgot MPIN entry points</td>
</tr>
<tr>
<td><strong>Type</strong></td>
<td>Feature</td>
</tr>
<tr>
<td><strong>Stack</strong></td>
<td>Node.js + NestJS (TypeScript)</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>Done</td>
</tr>
<tr>
<td><strong>Started</strong></td>
<td>2026-02-11</td>
</tr>
<tr>
<td><strong>Completed</strong></td>
<td>2026-02-11</td>
</tr>
<tr>
<td><strong>Dependencies</strong></td>
<td>Task 1.2 (sessions and lockout state)</td>
</tr>
</tbody>
</table>
<hr />
<h2>Checklist</h2>
<ul>
<li>[x] <code>POST /auth/lockout/status</code> returns current lockout state (locked until timestamp, attempts remaining)</li>
<li>[x] <code>POST /auth/forgot-mpin</code> initiates recovery — endpoint exists and returns 202 with documented behavior</li>
<li>[x] API error shape consistent; 403 for lockout where appropriate</li>
</ul>
<hr />
<h2>Implementation Details</h2>
<h3>POST /v1/auth/lockout/status</h3>
<p><strong>File</strong>: <code>src/modules/auth/auth.service.ts</code> → <code>getLockoutStatus()</code></p>
<p>Returns a structured lockout status response:</p>
<pre><code class="language-json">{
  &quot;isLocked&quot;: false,
  &quot;attemptsRemaining&quot;: 5,
  &quot;maxAttempts&quot;: 5,
  &quot;lockoutDurationMinutes&quot;: 15
}
</code></pre>
<p>When locked:</p>
<pre><code class="language-json">{
  &quot;isLocked&quot;: true,
  &quot;lockedUntil&quot;: &quot;2026-02-11T08:30:00.000Z&quot;,
  &quot;attemptsRemaining&quot;: 0,
  &quot;maxAttempts&quot;: 5,
  &quot;lockoutDurationMinutes&quot;: 15
}
</code></pre>
<p><strong>Security</strong>: Unknown <code>studentId</code> returns generic "not locked" response — does not leak whether the student exists.</p>
<p><strong>DTO</strong>: <code>LockoutStatusDto</code> validates <code>studentId</code> as required UUID. Invalid → 400 <code>VALIDATION_ERROR</code>.</p>
<h3>POST /v1/auth/forgot-mpin</h3>
<p><strong>File</strong>: <code>src/modules/auth/auth.service.ts</code> → <code>initForgotMpin()</code></p>
<p>Returns HTTP 202 Accepted:</p>
<pre><code class="language-json">{
  &quot;status&quot;: &quot;accepted&quot;,
  &quot;message&quot;: &quot;Recovery request received. If a matching account exists, instructions will be sent to the registered contact. Please contact your school administrator if you need immediate assistance.&quot;
}
</code></pre>
<p><strong>V1 scope</strong>: Entry point only. Full OTP/recovery flow deferred to external provider integration.</p>
<p><strong>DTO</strong>: <code>ForgotMpinDto</code> — <code>studentId</code> (optional UUID), <code>contact</code> (optional string, max 256).</p>
<p><strong>Audit</strong>: <code>FORGOT_MPIN_INITIATED</code> logged with requestId, IP, and whether contact was provided.</p>
<h3>Error Shape Consistency</h3>
<p>All error responses follow the global pattern:</p>
<pre><code class="language-json">{
  &quot;code&quot;: &quot;VALIDATION_ERROR&quot;,
  &quot;message&quot;: &quot;Request validation failed&quot;,
  &quot;details&quot;: [{ &quot;message&quot;: &quot;studentId must be a valid UUID&quot; }]
}
</code></pre>
<ul>
<li>400 — DTO validation failure</li>
<li>403 — Account locked (via <code>verifyMpin</code> flow from Task 1.2)</li>
<li>429 — Rate limited (via ThrottlerGuard)</li>
</ul>
<hr />
<h2>Files Modified</h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Change</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/modules/auth/auth.service.ts</code></td>
<td>Full <code>getLockoutStatus()</code> and <code>initForgotMpin()</code> implementations</td>
</tr>
<tr>
<td><code>src/modules/auth/auth.controller.ts</code></td>
<td>Updated lockout/status and forgot-mpin endpoints with request context</td>
</tr>
<tr>
<td><code>src/modules/auth/dto/lockout-status.dto.ts</code></td>
<td>Made <code>studentId</code> required (non-optional)</td>
</tr>
</tbody>
</table>
<hr />
<h2>Verification Results</h2>
<table>
<thead>
<tr>
<th>Test</th>
<th>Expected</th>
<th>Actual</th>
<th>Pass</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lockout status — known student, no lockout</td>
<td>200, isLocked:false, attemptsRemaining:5</td>
<td>200, isLocked:false, attemptsRemaining:5</td>
<td>✅</td>
</tr>
<tr>
<td>Lockout status — unknown student</td>
<td>200, isLocked:false (no leak)</td>
<td>200, isLocked:false</td>
<td>✅</td>
</tr>
<tr>
<td>Lockout status — missing studentId</td>
<td>400 VALIDATION_ERROR</td>
<td>400 VALIDATION_ERROR</td>
<td>✅</td>
</tr>
<tr>
<td>Lockout status — invalid UUID</td>
<td>400 VALIDATION_ERROR</td>
<td>400 VALIDATION_ERROR</td>
<td>✅</td>
</tr>
<tr>
<td>Forgot MPIN — valid request</td>
<td>202, status:accepted</td>
<td>202, status:accepted</td>
<td>✅</td>
</tr>
<tr>
<td>Forgot MPIN — minimal body</td>
<td>202, status:accepted</td>
<td>202, status:accepted</td>
<td>✅</td>
</tr>
<tr>
<td>Error shape</td>
<td>{code, message, details?}</td>
<td>{code, message, details?}</td>
<td>✅</td>
</tr>
</tbody>
</table></body>
</html>