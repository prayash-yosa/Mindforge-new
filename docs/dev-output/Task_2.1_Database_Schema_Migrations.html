<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Task 2.1 Database Schema Migrations</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;line-height:1.6;color:#1a1a1a}
table{border-collapse:collapse;width:100%;margin:1rem 0}
th,td{border:1px solid #d0d0d0;padding:0.5rem 0.75rem;text-align:left}
th{background:#f5f5f5;font-weight:600}
code{background:#f0f0f0;padding:0.15rem 0.3rem;border-radius:3px;font-size:0.9em}
pre{background:#f5f5f5;padding:1rem;border-radius:6px;overflow-x:auto}
pre code{background:none;padding:0}
h1{border-bottom:2px solid #333;padding-bottom:0.5rem}
h2{color:#333;margin-top:2rem}
h3{color:#555}
</style>
</head>
<body><h1>Task 2.1 — Database Schema and Migrations</h1>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sprint</strong></td>
<td>2 — Data &amp; Backend Core</td>
</tr>
<tr>
<td><strong>Task</strong></td>
<td>2.1</td>
</tr>
<tr>
<td><strong>Title</strong></td>
<td>Database schema and migrations</td>
</tr>
<tr>
<td><strong>Type</strong></td>
<td>Hardening</td>
</tr>
<tr>
<td><strong>Stack</strong></td>
<td>TypeORM + PostgreSQL (prod) / better-sqlite3 (dev)</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>Done</td>
</tr>
<tr>
<td><strong>Started</strong></td>
<td>2026-02-12</td>
</tr>
<tr>
<td><strong>Completed</strong></td>
<td>2026-02-12</td>
</tr>
</tbody>
</table>
<hr />
<h2>Checklist</h2>
<ul>
<li>[x] Tables: students, syllabus_metadata, teaching_feed, activities, questions, responses, attendance, doubt_threads, sessions, audit_log per architecture §5.1</li>
<li>[x] Indexes on student_id, activity_id, date (attendance), syllabus keys</li>
<li>[x] Migrations versioned and idempotent; applied via CI/deploy</li>
<li>[x] No direct DB access from business layer; only via data access layer</li>
</ul>
<hr />
<h2>Implementation Details</h2>
<h3>Technology</h3>
<ul>
<li><strong>TypeORM</strong> for ORM and migrations</li>
<li><strong>PostgreSQL</strong> driver (<code>pg</code>) for production</li>
<li><strong>better-sqlite3</strong> for development (no external DB needed)</li>
<li>Configuration via <code>ConfigService</code> — auto-detects environment</li>
</ul>
<h3>Entities (11 total)</h3>
<table>
<thead>
<tr>
<th>Entity</th>
<th>Table</th>
<th>Key Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StudentEntity</code></td>
<td><code>students</code></td>
<td>id, external_id, display_name, class, board, school, mpin_hash, consent flags</td>
</tr>
<tr>
<td><code>SyllabusMetadataEntity</code></td>
<td><code>syllabus_metadata</code></td>
<td>class, board, subject, chapter, topic, sort_order</td>
</tr>
<tr>
<td><code>TeachingFeedEntity</code></td>
<td><code>teaching_feed</code></td>
<td>class, date, summary, key_points, source_ref</td>
</tr>
<tr>
<td><code>ActivityEntity</code></td>
<td><code>activities</code></td>
<td>student_id, type (homework/quiz/test/gap_bridge), syllabus_id, status, score</td>
</tr>
<tr>
<td><code>QuestionEntity</code></td>
<td><code>questions</code></td>
<td>activity_id, type (mcq/short/long/tf/fill), content, options, correct_answer, rubric</td>
</tr>
<tr>
<td><code>ResponseEntity</code></td>
<td><code>responses</code></td>
<td>student_id, activity_id, question_id, answer, is_correct, score, feedback_level</td>
</tr>
<tr>
<td><code>AttendanceEntity</code></td>
<td><code>attendance</code></td>
<td>student_id, date, status (present/absent/late/excused), source_label</td>
</tr>
<tr>
<td><code>DoubtThreadEntity</code></td>
<td><code>doubt_threads</code></td>
<td>student_id, syllabus context (class/subject/chapter/topic), is_resolved</td>
</tr>
<tr>
<td><code>DoubtMessageEntity</code></td>
<td><code>doubt_messages</code></td>
<td>thread_id, role (student/ai/system), content, ai_model</td>
</tr>
<tr>
<td><code>SessionEntity</code></td>
<td><code>sessions</code></td>
<td>student_id, token, device_info, expires_at, is_revoked</td>
</tr>
<tr>
<td><code>AuditLogEntity</code></td>
<td><code>audit_log</code></td>
<td>request_id, action, student_id, ip_address, metadata</td>
</tr>
</tbody>
</table>
<h3>Indexes</h3>
<ul>
<li><code>students</code>: external_id (unique), class</li>
<li><code>syllabus_metadata</code>: (class, board, subject), (class, board, subject, chapter)</li>
<li><code>teaching_feed</code>: (class, date), date</li>
<li><code>activities</code>: student_id, (student_id, status), (student_id, type)</li>
<li><code>questions</code>: activity_id</li>
<li><code>responses</code>: student_id, (student_id, activity_id), (student_id, question_id)</li>
<li><code>attendance</code>: student_id, (student_id, date), date</li>
<li><code>doubt_threads</code>: student_id</li>
<li><code>doubt_messages</code>: thread_id</li>
<li><code>sessions</code>: student_id</li>
<li><code>audit_log</code>: action, student_id, created_at</li>
</ul>
<h3>Migration</h3>
<p>File: <code>src/database/migrations/20260211_001_initial_schema.ts</code></p>
<ul>
<li>Class: <code>InitialSchema20260211001</code></li>
<li>Idempotent: uses <code>createTable(table, true)</code> — IF NOT EXISTS</li>
<li>Full <code>down()</code> method drops tables in reverse dependency order</li>
<li>Production: <code>migrationsRun: true</code> auto-runs pending migrations on startup</li>
</ul>
<h3>DatabaseModule</h3>
<ul>
<li>Dual mode: PostgreSQL (when <code>DATABASE_URL</code> or <code>isProduction</code>) / SQLite (dev default)</li>
<li>Dev: <code>synchronize: true</code>, SQLite in-memory</li>
<li>Production: <code>synchronize: false</code>, migrations only, <code>retryAttempts: 3</code></li>
</ul>
<hr />
<h2>Files Created</h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/database/database.module.ts</code></td>
<td>TypeORM configuration module</td>
</tr>
<tr>
<td><code>src/database/entities/*.ts</code> (11 files)</td>
<td>Entity definitions</td>
</tr>
<tr>
<td><code>src/database/entities/index.ts</code></td>
<td>Barrel export</td>
</tr>
<tr>
<td><code>src/database/data-source.ts</code></td>
<td>CLI migration data source</td>
</tr>
<tr>
<td><code>src/database/migrations/20260211_001_initial_schema.ts</code></td>
<td>Versioned migration</td>
</tr>
<tr>
<td><code>src/config/configuration.ts</code></td>
<td>Added database config section</td>
</tr>
<tr>
<td><code>.env.example</code></td>
<td>Added DB connection variables</td>
</tr>
</tbody>
</table>
<hr />
<h2>Verification</h2>
<table>
<thead>
<tr>
<th>Test</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>Server starts with SQLite in-memory</td>
<td>Pass — all 11 tables created</td>
</tr>
<tr>
<td>Test student seeded via TypeORM</td>
<td>Pass — UUID auto-generated</td>
</tr>
<tr>
<td>Auth flow works (login → JWT → protected route)</td>
<td>Pass</td>
</tr>
<tr>
<td>No TypeScript build errors</td>
<td>Pass</td>
</tr>
</tbody>
</table></body>
</html>