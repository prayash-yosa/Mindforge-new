<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Task 1.4 Auth Middleware Bearer Validation</title>
<style>
body{font-family:system-ui,-apple-system,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;line-height:1.6;color:#1a1a1a}
table{border-collapse:collapse;width:100%;margin:1rem 0}
th,td{border:1px solid #d0d0d0;padding:0.5rem 0.75rem;text-align:left}
th{background:#f5f5f5;font-weight:600}
code{background:#f0f0f0;padding:0.15rem 0.3rem;border-radius:3px;font-size:0.9em}
pre{background:#f5f5f5;padding:1rem;border-radius:6px;overflow-x:auto}
pre code{background:none;padding:0}
h1{border-bottom:2px solid #333;padding-bottom:0.5rem}
h2{color:#333;margin-top:2rem}
h3{color:#555}
</style>
</head>
<body><h1>Task 1.4 — Auth Middleware and Bearer Token Validation</h1>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sprint</strong></td>
<td>1 — Foundation &amp; Auth</td>
</tr>
<tr>
<td><strong>Task</strong></td>
<td>1.4</td>
</tr>
<tr>
<td><strong>Title</strong></td>
<td>Auth middleware and Bearer token validation</td>
</tr>
<tr>
<td><strong>Type</strong></td>
<td>Hardening</td>
</tr>
<tr>
<td><strong>Stack</strong></td>
<td>Node.js + NestJS (TypeScript)</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>Done</td>
</tr>
<tr>
<td><strong>Started</strong></td>
<td>2026-02-11</td>
</tr>
<tr>
<td><strong>Completed</strong></td>
<td>2026-02-11</td>
</tr>
<tr>
<td><strong>Dependencies</strong></td>
<td>Task 1.2</td>
</tr>
</tbody>
</table>
<hr />
<h2>Checklist</h2>
<ul>
<li>[x] Middleware validates token/session on all routes except <code>/auth/*</code> and health</li>
<li>[x] Invalid or expired token → 401 with consistent error shape</li>
<li>[x] Authenticated <code>student_id</code> available to business layer for scope (no cross-student access)</li>
</ul>
<hr />
<h2>Implementation Details</h2>
<h3>AuthGuard — JWT Verification</h3>
<p><strong>File</strong>: <code>src/common/guards/auth.guard.ts</code></p>
<p>The global <code>AuthGuard</code> (registered via <code>APP_GUARD</code>) now performs real JWT verification:</p>
<ol>
<li><strong>@Public() bypass</strong>: Routes decorated with <code>@Public()</code> skip authentication (auth endpoints, health check)</li>
<li><strong>Header check</strong>: Missing or malformed <code>Authorization: Bearer &lt;token&gt;</code> → 401 <code>UNAUTHORIZED</code></li>
<li><strong>JWT verification</strong>: Uses <code>JwtService.verifyAsync(token, { secret })</code> with ConfigService secret</li>
<li><strong>Payload extraction</strong>: Extracts <code>sub</code>, <code>studentId</code>, <code>class</code>, <code>board</code> from JWT claims</li>
<li><strong>Request attachment</strong>: Attaches <code>AuthenticatedStudent</code> object to <code>request.student</code></li>
</ol>
<h3>Error Differentiation</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Code</th>
<th>Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>No Authorization header</td>
<td><code>UNAUTHORIZED</code></td>
<td>Missing or invalid authorization token</td>
</tr>
<tr>
<td>Malformed Bearer</td>
<td><code>UNAUTHORIZED</code></td>
<td>Missing or invalid authorization token</td>
</tr>
<tr>
<td>Expired JWT</td>
<td><code>TOKEN_EXPIRED</code></td>
<td>Session expired. Please log in again.</td>
</tr>
<tr>
<td>Invalid/tampered JWT</td>
<td><code>INVALID_TOKEN</code></td>
<td>Invalid authorization token</td>
</tr>
<tr>
<td>Wrong secret</td>
<td><code>INVALID_TOKEN</code></td>
<td>Invalid authorization token</td>
</tr>
</tbody>
</table>
<p>All errors return consistent shape: <code>{ code, message }</code></p>
<h3>@Student() Parameter Decorator</h3>
<p><strong>File</strong>: <code>src/common/decorators/student.decorator.ts</code></p>
<p>Clean extraction of authenticated student in controllers:</p>
<pre><code class="language-typescript">// Full student object
@Get('profile')
getProfile(@Student() student: AuthenticatedStudent) {
  return this.service.getProfile(student.id);
}

// Single property
@Get('settings')
getSettings(@Student('id') studentId: string) {
  return this.service.getSettings(studentId);
}
</code></pre>
<h3>Student Scoping (No Cross-Student Access)</h3>
<p>The <code>AuthenticatedStudent</code> interface attached to the request:</p>
<pre><code class="language-typescript">interface AuthenticatedStudent {
  id: string;        // from JWT sub
  studentId: string; // from JWT studentId
  class: string;     // from JWT class
  board: string;     // from JWT board
}
</code></pre>
<p>Business layer accesses only <code>request.student.id</code> — no way to query another student's data through the API.</p>
<h3>Protected Endpoint Demo</h3>
<p><strong>File</strong>: <code>src/modules/student/student.controller.ts</code></p>
<p><code>GET /v1/student/me</code> — returns the authenticated student context (requires Bearer token):</p>
<pre><code class="language-json">{
  &quot;studentId&quot;: &quot;a1b2c3d4-e5f6-7890-abcd-ef1234567890&quot;,
  &quot;class&quot;: &quot;8&quot;,
  &quot;board&quot;: &quot;CBSE&quot;,
  &quot;message&quot;: &quot;Authenticated via JWT (AuthGuard Task 1.4)&quot;
}
</code></pre>
<hr />
<h2>Files Modified / Created</h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Change</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/common/guards/auth.guard.ts</code></td>
<td>Full JWT verification via JwtService + ConfigService</td>
</tr>
<tr>
<td><code>src/common/decorators/student.decorator.ts</code></td>
<td><strong>New</strong> — @Student() param decorator</td>
</tr>
<tr>
<td><code>src/modules/auth/auth.module.ts</code></td>
<td>Made <code>@Global()</code>, exports JwtModule for AuthGuard DI</td>
</tr>
<tr>
<td><code>src/modules/student/student.controller.ts</code></td>
<td><strong>New</strong> — GET /v1/student/me (protected endpoint demo)</td>
</tr>
<tr>
<td><code>src/modules/student/student.module.ts</code></td>
<td>Registered StudentController</td>
</tr>
</tbody>
</table>
<hr />
<h2>Verification Results</h2>
<table>
<thead>
<tr>
<th>Test</th>
<th>Expected</th>
<th>Actual</th>
<th>Pass</th>
</tr>
</thead>
<tbody>
<tr>
<td>Protected route — no token</td>
<td>401 UNAUTHORIZED</td>
<td>401 UNAUTHORIZED</td>
<td>✅</td>
</tr>
<tr>
<td>Protected route — garbage token</td>
<td>401 INVALID_TOKEN</td>
<td>401 INVALID_TOKEN</td>
<td>✅</td>
</tr>
<tr>
<td>Protected route — expired token</td>
<td>401 TOKEN_EXPIRED</td>
<td>401 TOKEN_EXPIRED</td>
<td>✅</td>
</tr>
<tr>
<td>Protected route — wrong secret</td>
<td>401 INVALID_TOKEN</td>
<td>401 INVALID_TOKEN</td>
<td>✅</td>
</tr>
<tr>
<td>Protected route — valid token</td>
<td>200 with student context</td>
<td>200 with studentId, class, board</td>
<td>✅</td>
</tr>
<tr>
<td>Public route /health — no token</td>
<td>200</td>
<td>200</td>
<td>✅</td>
</tr>
<tr>
<td>Public route /v1/auth/* — no token</td>
<td>200</td>
<td>200</td>
<td>✅</td>
</tr>
<tr>
<td>Student scoping</td>
<td>JWT studentId in response</td>
<td>Matches JWT sub claim</td>
<td>✅</td>
</tr>
</tbody>
</table></body>
</html>